# SubNodeSync 架构文档

## 概述

SubNodeSync 是一个分布式节点同步框架，用于管理和监控分布式应用实例。它提供节点注册、心跳管理、命令控制等功能。

## 设计目标

1. **轻量级** - 最小化对业务应用的侵入
2. **可靠性** - 自动重连、消息确认
3. **可扩展** - 支持自定义命令处理
4. **易用性** - 一行代码集成

## 架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                         SubNodeSync 框架                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                      应用层 (Application)                      │  │
│  │                                                                │  │
│  │   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐      │  │
│  │   │    node     │    │    sync     │    │     log     │      │  │
│  │   │   节点管理   │    │  命令同步   │    │    日志     │      │  │
│  │   └──────┬──────┘    └──────┬──────┘    └─────────────┘      │  │
│  │          │                  │                                  │  │
│  └──────────┼──────────────────┼──────────────────────────────────┘  │
│             │                  │                                      │
│  ┌──────────┴──────────────────┴──────────────────────────────────┐  │
│  │                      传输层 (Transport)                         │  │
│  │                                                                  │  │
│  │   ┌─────────────────────────────────────────────────────┐      │  │
│  │   │                   MQTT Client                        │      │  │
│  │   │                                                       │      │  │
│  │   │  - 连接管理    - 消息发布/订阅    - 自动重连         │      │  │
│  │   └─────────────────────────────────────────────────────┘      │  │
│  │                                                                  │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                    │                                    │
└────────────────────────────────────┼────────────────────────────────────┘
                                     │
                              ┌──────┴──────┐
                              │ MQTT Broker │
                              │  (外部服务)  │
                              └─────────────┘
```

## 核心模块

### 1. 节点管理模块 (pkg/node)

负责节点的注册、心跳和生命周期管理。

```
node/
├── node.go         # 节点注册入口
└── instance.go     # 实例管理（内嵌在node.go中）
```

**核心流程:**

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   Register  │────▶│ Connect MQTT│────▶│ Start Heart │
│             │     │             │     │    beat     │
└─────────────┘     └─────────────┘     └─────────────┘
                           │
                           ▼
                    ┌─────────────┐
                    │ HTTP Register│
                    │  (optional)  │
                    └─────────────┘
```

### 2. 命令同步模块 (pkg/sync)

处理来自管理引擎的控制命令。

```
sync/
├── command.go      # 命令接收器
├── context.go      # 生命周期上下文
└── handlers.go     # 内置命令处理器
```

**命令处理流程:**

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│ MQTT Message│────▶│   Parse     │────▶│   Dispatch  │
│   Received  │     │   Command   │     │  to Handler │
└─────────────┘     └─────────────┘     └─────────────┘
                                               │
                                               ▼
                                        ┌─────────────┐
                                        │   Execute   │
                                        │   Handler   │
                                        └─────────────┘
```

### 3. 传输层模块 (pkg/transport)

封装MQTT客户端，提供消息传输能力。

```
transport/
└── mqtt.go         # MQTT客户端封装
```

**消息类型:**

| 类型 | 方向 | 描述 |
|------|------|------|
| register | 节点→引擎 | 注册消息 |
| heartbeat | 节点→引擎 | 心跳消息 |
| control | 引擎→节点 | 控制命令 |
| status | 节点→引擎 | 状态上报 |

### 4. 日志模块 (pkg/log)

基于zap的结构化日志封装。

```
log/
└── log.go          # 日志封装
```

## 数据流

### 节点注册流程

```
┌─────────┐         ┌─────────┐         ┌─────────┐
│  节点   │         │  MQTT   │         │  引擎   │
│         │         │ Broker  │         │         │
└────┬────┘         └────┬────┘         └────┬────┘
     │                   │                   │
     │ 1. Connect        │                   │
     │──────────────────▶│                   │
     │                   │                   │
     │ 2. Subscribe      │                   │
     │──────────────────▶│                   │
     │   (control topic) │                   │
     │                   │                   │
     │ 3. Publish        │                   │
     │──────────────────▶│ 4. Forward       │
     │  (register msg)   │──────────────────▶│
     │                   │                   │
     │                   │                   │ 5. Process
     │                   │                   │   Register
     │                   │                   │
```

### 心跳流程

```
┌─────────┐         ┌─────────┐         ┌─────────┐
│  节点   │         │  MQTT   │         │  引擎   │
│         │         │ Broker  │         │         │
└────┬────┘         └────┬────┘         └────┬────┘
     │                   │                   │
     │ 1. Publish        │                   │
     │──────────────────▶│ 2. Forward       │
     │ (heartbeat msg)   │──────────────────▶│
     │                   │                   │
     │                   │                   │ 3. Update
     │                   │                   │   Status
     │                   │                   │
     │ (every 30s)       │                   │
     │                   │                   │
```

### 命令控制流程

```
┌─────────┐         ┌─────────┐         ┌─────────┐
│  节点   │         │  MQTT   │         │  引擎   │
│         │         │ Broker  │         │         │
└────┬────┘         └────┬────┘         └────┬────┘
     │                   │                   │
     │                   │ 1. Publish        │
     │                   │◀──────────────────│
     │                   │  (control msg)    │
     │ 2. Receive        │                   │
     │◀──────────────────│                   │
     │                   │                   │
     │ 3. Execute        │                   │
     │   Command         │                   │
     │                   │                   │
     │ 4. Publish        │                   │
     │──────────────────▶│ 5. Forward       │
     │  (result msg)     │──────────────────▶│
     │                   │                   │
```

## 消息格式

### 注册消息

```json
{
  "timestamp": "2024-01-01T12:00:00Z",
  "node_name": "my-app",
  "instance_id": "my-app-hostname-12345",
  "version": "1.0.0",
  "pid": 12345,
  "start_time": "2024-01-01T12:00:00Z",
  "capabilities": ["mqtt_control", "heartbeat"],
  "metadata": {
    "hostname": "hostname"
  },
  "node_version": {
    "git_version": "v1.0.0",
    "git_commit": "abc123",
    "build_date": "2024-01-01",
    "go_version": "go1.21",
    "platform": "linux/amd64"
  }
}
```

### 心跳消息

```json
{
  "timestamp": "2024-01-01T12:00:00Z",
  "node_name": "my-app",
  "instance_id": "my-app-hostname-12345",
  "status": "running",
  "pid": 12345,
  "uptime": 3600,
  "version": "1.0.0",
  "hostname": "hostname",
  "metrics": {
    "process_cpu_usage_percent": "2.50",
    "process_memory_usage_mb": 128,
    "process_goroutine_count": 42
  }
}
```

### 控制消息

```json
{
  "command": "stop",
  "timestamp": "2024-01-01T12:00:00Z",
  "request_id": "req-123",
  "parameters": {}
}
```

## 实例唯一标识

为了支持同名应用多实例场景，使用以下格式生成唯一实例ID：

```
{node_name}-{hostname}-{pid}
```

例如：`my-app-server01-12345`

## 自动重连机制

```
┌─────────────────────────────────────────────────────────┐
│                      重连状态机                          │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  ┌─────────┐     连接成功      ┌─────────┐              │
│  │Connecting│──────────────────▶│Connected│              │
│  └────┬────┘                    └────┬────┘              │
│       │                              │                    │
│       │ 连接失败                     │ 连接丢失          │
│       │                              │                    │
│       ▼                              ▼                    │
│  ┌─────────┐     等待重连      ┌─────────┐              │
│  │  Wait   │◀──────────────────│Reconnect│              │
│  └────┬────┘                    └─────────┘              │
│       │                                                   │
│       │ 15分钟后                                         │
│       │                                                   │
│       └──────────────────────────────────────────────────│
│                        重试连接                          │
└─────────────────────────────────────────────────────────┘
```

## 配置优先级

```
1. 代码设置 (最高优先级)
   ↓
2. 环境变量
   ↓
3. 默认值 (最低优先级)
```

## 扩展点

### 自定义命令处理器

实现 `CommandHandler` 接口：

```go
type CommandHandler interface {
    Handle(ctx context.Context, cmd *Command) (*CommandResult, error)
    GetCommandName() string
}
```

### 自定义传输层

可以替换MQTT实现其他传输协议（如HTTP长轮询、WebSocket等）。

### 自定义监控指标

通过心跳消息的 `metrics` 字段上报自定义指标。

## 性能考虑

1. **心跳间隔**: 默认30秒，可根据网络状况调整
2. **重连间隔**: 默认15分钟，采用指数退避策略
3. **消息QoS**: 使用QoS 1确保消息至少投递一次
4. **并发处理**: 命令处理器在独立goroutine中执行

## 安全考虑

1. **MQTT认证**: 支持用户名/密码认证
2. **TLS加密**: 支持TLS连接
3. **访问控制**: 通过MQTT ACL控制主题访问权限

